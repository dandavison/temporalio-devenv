#!/usr/bin/env bash
#
# category: Temporal, Infra
# help: Troubleshoot and clear credential caches for AWS/granted/omni access issues
# help:
# help: Use this script when you see errors like:
# help:   - "The security token included in the request is invalid"
# help:   - "InvalidClientTokenId when calling AssumeRole"
# help:   - "UnrecognizedClientException"
# help:
# help: These errors often occur when cached credentials become stale but the
# help: access tools still think they're valid.
#
# tag: owner team: foundations
# tag: owner channel: #team-infra

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }
log_header() { echo -e "\n${BOLD}=== $* ===${NC}"; }
run_cmd() { echo "+ $*" >&2; "$@"; }

show_help() {
    cat <<EOF
Usage: $(basename "$0") [command]

Commands:
  status      Show current credential cache status (default)
  clear       Clear all credential caches
  clear-aws   Clear only AWS CLI cache
  clear-granted Clear only granted credential cache
  test        Test AWS credentials for a profile
  help        Show this help message

Examples:
  $(basename "$0")                    # Show status
  $(basename "$0") clear              # Clear all caches
  $(basename "$0") test oss-e2e/AWSAdministratorAccess
EOF
}

show_status() {
    log_header "AWS CLI Cache"
    if [[ -d ~/.aws/cli/cache ]]; then
        local count
        count=$(find ~/.aws/cli/cache -type f 2>/dev/null | wc -l | tr -d ' ')
        log_info "Location: ~/.aws/cli/cache"
        log_info "Files: $count"
        if [[ -f ~/.aws/cli/cache/session.db ]]; then
            local info
            info=$(ls -lh ~/.aws/cli/cache/session.db | awk '{print $5, $6, $7, $8}')
            log_info "Session DB: $info"
        fi
    else
        log_info "No AWS CLI cache directory found"
    fi

    log_header "Granted Session Credentials Cache"
    if [[ -d ~/.granted/secure-storage-aws-session-credentials ]]; then
        log_info "Location: ~/.granted/secure-storage-aws-session-credentials"
        local files
        files=$(ls -1 ~/.granted/secure-storage-aws-session-credentials 2>/dev/null || true)
        if [[ -n "$files" ]]; then
            echo "$files" | while read -r f; do
                local decoded
                decoded=$(echo "$f" | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))" 2>/dev/null || echo "$f")
                log_info "  - $decoded"
            done
        else
            log_info "  (empty)"
        fi
    else
        log_info "No granted session cache found"
    fi

    log_header "Granted SSO Tokens Cache"
    if [[ -d ~/.granted/secure-storage-aws-sso-tokens ]]; then
        log_info "Location: ~/.granted/secure-storage-aws-sso-tokens"
        local files
        files=$(ls -1 ~/.granted/secure-storage-aws-sso-tokens 2>/dev/null || true)
        if [[ -n "$files" ]]; then
            echo "$files" | while read -r f; do
                local decoded
                decoded=$(echo "$f" | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))" 2>/dev/null || echo "$f")
                log_info "  - $decoded"
            done
        else
            log_info "  (empty)"
        fi
    else
        log_info "No granted SSO token cache found"
    fi

    log_header "AWS SSO Cache"
    if [[ -d ~/.aws/sso/cache ]]; then
        log_info "Location: ~/.aws/sso/cache"
        for f in ~/.aws/sso/cache/*.json; do
            if [[ -f "$f" ]]; then
                local expires
                expires=$(python3 -c "import json; print(json.load(open('$f')).get('expiresAt', 'unknown'))" 2>/dev/null || echo "unknown")
                log_info "  - $(basename "$f"): expires $expires"
            fi
        done
    else
        log_info "No AWS SSO cache found"
    fi
}

clear_aws_cache() {
    log_header "Clearing AWS CLI Cache"
    if [[ -d ~/.aws/cli/cache ]]; then
        run_cmd rm -rf ~/.aws/cli/cache/*
        log_success "Cleared ~/.aws/cli/cache/"
    else
        log_info "No AWS CLI cache to clear"
    fi
}

clear_granted_cache() {
    log_header "Clearing Granted Caches"

    if [[ -d ~/.granted/secure-storage-aws-session-credentials ]]; then
        run_cmd rm -rf ~/.granted/secure-storage-aws-session-credentials/*
        log_success "Cleared ~/.granted/secure-storage-aws-session-credentials/"
    else
        log_info "No granted session credentials cache to clear"
    fi

    if [[ -d ~/.granted/secure-storage-aws-sso-tokens ]]; then
        run_cmd rm -rf ~/.granted/secure-storage-aws-sso-tokens/*
        log_success "Cleared ~/.granted/secure-storage-aws-sso-tokens/"
    else
        log_info "No granted SSO tokens cache to clear"
    fi
}

clear_all() {
    clear_aws_cache
    clear_granted_cache
    log_success "All credential caches cleared"
}

test_profile() {
    local profile="${1:-}"
    if [[ -z "$profile" ]]; then
        log_error "Usage: $(basename "$0") test <profile-name>"
        log_info "Example: $(basename "$0") test oss-e2e/AWSAdministratorAccess"
        exit 1
    fi

    log_header "Testing profile: $profile"

    log_info "Checking if profile exists in ~/.aws/config..."
    if grep -q "\[profile $profile\]" ~/.aws/config 2>/dev/null; then
        log_success "Profile found"
    else
        log_error "Profile not found in ~/.aws/config"
        exit 1
    fi

    log_info "Testing granted credential-process..."
    if granted credential-process --profile "$profile" >/dev/null 2>&1; then
        log_success "granted credential-process succeeded"
    else
        log_error "granted credential-process failed"
        log_info "Try: granted credential-process --profile $profile"
        exit 1
    fi

    log_info "Testing AWS STS get-caller-identity..."
    if AWS_PROFILE="$profile" aws sts get-caller-identity 2>/dev/null; then
        log_success "AWS credentials are valid"
    else
        log_error "AWS credentials are invalid"
        log_warn "Try clearing caches: $(basename "$0") clear"
        exit 1
    fi
}

main() {
    local cmd="${1:-status}"

    case "$cmd" in
        status)
            show_status
            ;;
        clear)
            clear_all
            ;;
        clear-aws)
            clear_aws_cache
            ;;
        clear-granted)
            clear_granted_cache
            ;;
        test)
            test_profile "${2:-}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $cmd"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
