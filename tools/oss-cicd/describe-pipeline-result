#!/usr/bin/env bash
# Get details from a pipeline workflow as JSON
# Usage: ./oss-cicd/tools/investigate/describe-pipeline Nightlies/6586701f/PipelineCassEs/14/chasm

set -euo pipefail

WORKFLOW_ID="${1:?Usage: $0 <pipeline-workflow-id>}"

# Cache lookup
SCRIPT_NAME="$(basename "$0")"
CACHE_KEY="${SCRIPT_NAME}--${*//\//-}.json"
CACHE_FILE=".describe/$CACHE_KEY"
if [[ -f "$CACHE_FILE" ]]; then
  cat "$CACHE_FILE"
  exit 0
fi

(omni temporal --yes -o json workflow show -n oss-cicd.e2e -w "$WORKFLOW_ID" | \
    jq -r '.events[] | select(.workflowExecutionCompletedEventAttributes) | .workflowExecutionCompletedEventAttributes.result.payloads[0].data' | \
    base64 -d || echo '{}') | tee "$CACHE_FILE"
